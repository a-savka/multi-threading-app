# Многопоточное приложение для работы с валютами

Приложение предназначенно для получения, парсинга и сохранения курсов валют из внешних API с использованием многопоточности.

## Структура проекта

Проект следует стандартной структуре Spring Boot с пакетами: `config`, `controller`, `dto`, `entity`, `repository`, `service`, `util` и `worker`.

## Используемые технологии

* Spring Boot 3.x
* Java 17
* Maven
* Spring Data JPA
* База данных H2 (in-memory)
* Lombok
* WebClient (Spring WebFlux)

## Как запустить

1. **Клонируйте репозиторий**
2. **Перейдите в корневую директорию проекта**: `cd multi-threading-app`
3. **Соберите проект**: `mvn clean install`
4. **Запустите приложение**: `mvn spring-boot:run`

По умолчанию приложение запускается по адресу `http://localhost:8080`.



## Поддерживаемые валюты

- USD
- EUR
- GBP
- JPY
- GEL
- TRY



## Быстрый тест приложения

после старта приложения запустить:

1. http://localhost:8080/jobs/fetch/start
2. http://localhost:8080/jobs/parse/start
3. http://localhost:8080/rates/raw/responses?status=PROCESSED если ответ пустой массив - подождать 10 сек и повторить
4. http://localhost:8080/rates/latest?currency=TRY (либо для любой другой из поддерживаемых валют перечисленных выше валют)

в итоге последний запрос вернет последний полученый курс для данной валюты в рублевом базисе.

## Логика Работы (Подробное описание)

Приложение запускает 2 потока управления: один для фетчинга данных, второй - для парсинга. По умолчанию после старта приложения потоки остановлены, для их запуска нужно воспользоваться соответствующими ендпоинтами:

- http://localhost:8080/jobs/fetch/start
- http://localhost:8080/jobs/parse/start
-  http://localhost:8080/rates/raw/responses?status=PROCESSED если ответ пустой массив - подождать 10 сек и повторить
- http://localhost:8080/rates/latest?currency=TRY

после запуска управляющих потоков, они переодически будут запускать соответствеющие воркеры:

ApiFetchWorker - используется для получения данных от внешних АПИ курсов валют и их сохранения в БД в необработанном виде

ParserWorker - проверяет наличие в БД необработанных данных и выполняет их парсинг и сохранение в БД в структурированом виде, позволяющем запрашивать информацию о курсах валют.

То, что приложение успешно получило и обработало данные можно увидеть либо в логе консоли, либо запустив запрос на ендпоинт http://localhost:8080/rates/raw/responses?status=PROCESSED Если в результате запроса приложение вернет не пустой массив, значить уже есть обработанные данные (пока что они после процессинга не удаляются а хранятся для истории, просто им меняется статус на PROCESSED).

Далее можно использовать ендпоинты для получения курса отдельной валюты, например:
http://localhost:8080/rates/latest?currency=TRY

**Примечание** Так как было уже сложно найти открытый АПИ не требующий ключа, остановился на сервисе exchangerateshost (https://www.cbr-xml-daily.ru/daily_json.js) который сразу возвращает данные по всем валютам, которые он поддерживает. Но фетчер для имитации многопоточности делает этот запрос для каждой из сконфигурированных валют. Далее уже парсер извлекает данные по нужной в данный момент валюте. Так как сервис Российский, то вернет значение валюты в рублевом базисе.

## API-эндпоинты

Приложение предоставляет следующие REST API-эндпоинты:

### Управление задачами (Base URL: `/jobs`)

* **Начать получение**
  * `GET /jobs/fetch/start`
  * Описание: запускает периодическое получение курсов валют из настроенных API-источников.
  * Пример: `curl http://localhost:8080/jobs/fetch/start`

* **Остановить получение**
  * `GET /jobs/fetch/stop`
  * Описание: останавливает процесс периодического получения.
  * Пример: `curl http://localhost:8080/jobs/fetch/stop`

* **Начать парсинг**
  * `GET /jobs/parse/start`
  * Описание: запускает периодический парсинг необработанных ответов API в структурированные курсы валют.
  * Пример: `curl http://localhost:8080/jobs/parse/start`

* **Остановить парсинг**
  * `GET /jobs/parse/stop`
  * Описание: останавливает процесс периодического парсинга.
  * Пример: `curl http://localhost:8080/jobs/parse/stop`

* **Получить статус задач**
  * `GET /jobs/status`
  * Описание: возвращает текущий статус исполнительных процессов получения и парсинга.
  * Пример: `curl http://localhost:8080/jobs/status`

### Данные о валютных курсах (Base URL: `/rates`)

* **Получить последний курс по валюте**
  * `GET /rates/latest?currency={currencyCode}`
  * Описание: возвращает последний доступный курс указанной валюты (например, USD, EUR).
  * Пример: `curl "http://localhost:8080/rates/latest?currency=USD"`

* **Получить курсы по валюте и диапазону дат**
  * `GET /rates?currency={currencyCode}&from={startDateTime}&to={endDateTime}`
  * Описание: возвращает курсы валюты за указанный период времени.
  * Пример:  
    `curl "http://localhost:8080/rates?currency=USD&from=2025-01-01T00:00:00&to=2025-12-31T23:59:59"`

* **Получить необработанные API-ответы по статусу**
  * `GET /rates/raw/responses?status={status}`
  * Описание: возвращает необработанные ответы API, отфильтрованные по статусу  
    (NEW, PROCESSING, PROCESSED, FAILED). Полезно для отладки.
  * Пример: `curl "http://localhost:8080/rates/raw/responses?status=NEW"`

## Конфигурация

Приложение можно настроить через файл `src/main/resources/application.yml`.  
Ключевые свойства:

* `app.supported-currencies`: список отслеживаемых валют
* `app.api-sources`: конфигурация внешних API-источников (id, название, URL, таймаут)
* `app.fetch.max-concurrent-fetchers`: максимальное число потоков получения
* `app.fetch.fetch-interval-ms`: интервал периодического получения
* `app.fetch.retry`: настройки повторных попыток
* `app.parser.max-concurrent-parsers`: максимальное число потоков парсинга
* `app.parser.polling-batch-size`: количество ответов для обработки за одну итерацию

## Начальные данные

При запуске приложения сущности `ApiSourceConfig` инициализируются в базе данных H2  
на основе свойства `app.api-sources` в `application.yml`.

